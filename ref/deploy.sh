#!/bin/bash

# ----------------------------------------------------------------
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è —Å–∞–π—Ç–∞ —á–µ—Ä–µ–∑ Git (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è)
#
# –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
# 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ GitHub.
# 2. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç `git pull`.
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
# ./deploy.sh
# (–°–∫—Ä–∏–ø—Ç —Å–∞–º –ø–æ–ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–º–∏—Ç–∞)
# ----------------------------------------------------------------

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
REMOTE_USER="root"
REMOTE_HOST="109.196.102.71"

# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å —Å–∞–π—Ç–æ–º –ù–ê –°–ï–†–í–ï–†–ï
REMOTE_PATH="/var/www/leademy-website"

# --- –ö–û–î –°–ö–†–ò–ü–¢–ê ---

# –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –ª—é–±–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π
set -e

# 1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–º–∏—Ç–∞
read -p "üí¨  –í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–º–∏—Ç–∞: " COMMIT_MESSAGE

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ
if [ -z "$COMMIT_MESSAGE" ]; then
    echo # –ü–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
    echo "üõë –û—à–∏–±–∫–∞: –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–º–∏—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."
    exit 1
fi

# 2. –î–æ–±–∞–≤–ª—è–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ GitHub
echo "‚öôÔ∏è  –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ GitHub..."
git add .
git commit -m "$COMMIT_MESSAGE"
git push origin main # –ï—Å–ª–∏ –≤–µ—Ç–∫–∞ master, –∑–∞–º–µ–Ω–∏—Ç–µ main –Ω–∞ master

echo "‚úÖ  –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ GitHub."

# 3. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ —Å–∫–∞—á–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
echo "üöö  –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

# –§–æ—Ä–º–∏—Ä—É–µ–º –æ–¥–Ω—É –±–æ–ª—å—à—É—é –∫–æ–º–∞–Ω–¥—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–∞.
REMOTE_COMMANDS="
  cd ${REMOTE_PATH} && \\
  echo '--- 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å GitHub ---' && \\
  git fetch origin main && \\ 
  git reset --hard origin/main && \\
  echo '--- 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç ---' && \\
  docker compose exec -T app chown -R www-data:www-data /var/www/html && \\
  echo '--- 3. –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Composer ---' && \\
  docker compose exec -T --user www-data app composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader && \\
  echo '--- 4. –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ ---' && \\
  docker compose exec -T --user www-data app php artisan storage:link --force && \\
  echo '--- 5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ---' && \
  docker compose exec -T --user www-data app php artisan october:up && \
  echo '--- 6. –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---' && \\
  docker compose exec -T --user www-data app php artisan route:clear && \\
  docker compose exec -T --user www-data app php artisan view:clear && \\
  docker compose exec -T --user www-data app php artisan config:clear && \\
  docker compose exec -T --user www-data app php artisan cache:clear && \\
  echo '‚úÖ  –î–µ–ø–ª–æ–π –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.'
"

ssh "${REMOTE_USER}@${REMOTE_HOST}" "${REMOTE_COMMANDS}"

echo
echo "üéâ  –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!!"
echo
echo "‚ÑπÔ∏è  –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤—ã –≤–Ω–æ—Å–∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Dockerfile, docker-compose.yml –∏–ª–∏ entrypoint.sh,"
echo "   —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–µ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–ª –æ–±—Ä–∞–∑. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
echo "   ssh ${REMOTE_USER}@${REMOTE_HOST} 'cd ${REMOTE_PATH} && docker compose up -d --build'"
echo