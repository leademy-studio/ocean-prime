# Инструкция по проекту leademy-digital

## Краткое описание

Проект `leademy-digital` — сайт на базе October CMS (Laravel-подобный движок). Исходный код приложения находится в папке `october/`. Проект в этом репозитории содержит конфигурации для запуска через Docker (Traefik, Nginx, PHP-FPM, MySQL), сборки фронтенда (Webpack / Laravel Mix) и все необходимые зависимости для разработки и продакшена.

---

## Зависимости (основные)

- **PHP**: требуется PHP >= 8.2 (см. `october/composer.json`, поле `require`).
- **Composer**: для установки PHP-зависимостей (Laravel, October Rain и прочих пакетов).
- **Node.js & npm/yarn**: для сборки фронтенд-ассетов (см. `october/package.json`).
- **Docker & docker-compose**: рекомендовано для локальной разработки — содержит сервисы Traefik, nginx, app (PHP-FPM), db (MySQL).
- **Системные/инструментальные зависимости**:
  - PHPUnit и PHP_CodeSniffer в dev-зависимостях (`october/composer.json`).
  - Laravel Mix, Sass, Less и др. в `october/package.json` для сборки ассетов.

---

## Важные файлы и за что они отвечают

- `docker-compose.yml` — конфигурация докер-окружения (Traefik, nginx, app, db). Служит для поднятия локального стека.
- `Dockerfile` — описание образа приложения (используется для `app` сервиса).
- `nginx/default.conf` — конфигурация nginx, которая отдаёт статические файлы и проксирует PHP-запросы в PHP-FPM (контейнер `app`).
- `traefik/` — конфигурация Traefik (обратный прокси, TLS, маршрутизация доменов).
- `october/` — корневая директория самого October CMS-приложения:

  - `index.php` — точка входа (front controller) для веб-запросов.
  - `artisan` — консольные команды (аналог Laravel Artisan) для миграций, очистки кэша и т.д.
  - `.env` / `.env.example` — переменные окружения для приложения (подключение к БД, секреты и т.п.).
  - `composer.json` — PHP-зависимости и скрипты Composer.
  - `package.json`, `webpack.mix.js`, `webpack.config.js` — настройки сборки фронтенда.
  - `app/` — код приложения (провайдеры, кастомные сервисы, blueprints).
  - `modules/` — модули October (backend, cms, system и т.д.) — основная логика движка.
  - `plugins/` — папка с плагинами проекта (расширения, кастомная функциональность).
  - `themes/leademy/` — тема сайта: шаблоны, partial'ы, assets, layout'ы.
  - `storage/` — загрузки, сессии, кэш и логи — важно обеспечить запись на продакшене.
  - `public/` — (в проекте может быть пустая папка с `.gitkeep`) — общедоступная директория для статических файлов.

- `php/php.ini` — файл настройки PHP, применяется при сборке контейнера/образа.
- `docker/app/entrypoint.sh` — скрипт запуска контейнера приложения (инициализация, права, запуск демонов и т.п.).
- `scripts/` — пользовательские скрипты/утилиты (может содержать вспомогательные команды для разработки/деплоя).

---

## Как всё взаимодействует (поток запроса / разработки)

1. Внешний запрос приходит на Traefik (порт 80/443) — он выполняет TLS и маршрутизацию в зависимости от правила хоста.
2. Traefik направляет запрос к контейнеру `nginx` (или напрямую к `app`, если настроено иначе). `nginx` отдаёт статические ресурсы (из `october`), а динамические запросы проксирует в `app` (PHP-FPM).
3. PHP-FPM в контейнере `app` обрабатывает `index.php` в `october/`, который инициализирует October CMS, загружает сервис-провайдеры и роуты.
4. Контроллеры/модели содержатся в `modules/`, `plugins/` и `app/`. Для отображения используются шаблоны темы в `themes/leademy/`.
5. Ассеты (CSS/JS) собираются через Laravel Mix (`webpack.mix.js`) с использованием пакетов, указанных в `october/package.json`. На проде рекомендуется запускать `npm run production` и выкладывать собранные ассеты.

---

## Часто используемые команды

- Поднять окружение (Docker):
  - `docker compose up -d`
- Остановить окружение:
  - `docker compose down`
- Выполнить artisan-команду в контейнере приложения:
  - `docker compose exec app php artisan <команда>`
- Установить PHP-зависимости (локально / внутри контейнера):
  - `composer install` (из папки `october/` или в контейнере `app`)
- Установить Node-зависимости и собрать ассеты:
  - `cd october && npm install`
  - `npm run dev` или `npm run production`
- Очистить кэш и пересобрать контейнеры/ресурсы:
  - `docker compose exec app php artisan cache:clear`
  - `docker compose exec app php artisan view:clear`

---

## Рекомендации по деплою и окружению

- Всегда храните чувствительные переменные в `october/.env` (в продакшне используйте секрет-менеджер или CI переменные), а в репозитории — `.env.example`.
- `storage/` и `bootstrap/cache` должны быть доступны для записи процессом PHP — проверьте права после деплоя.
- Бэкап базы данных и `storage/` обязателен перед обновлениями плагинов/ядра.
- Обновления совершайте в порядке: composer update → миграции → сборка фронтенда → перезапуск сервисов.

---

## Короткая карта ответственных областей (кто за что отвечает в кодовой базе)

- Темы (`themes/leademy/`): верстка, вывод контента, partial'ы — фронтенд-разработчики/дизайнеры.
- Плагины (`plugins/`): бизнес-логика, интеграции, кастомная функциональность — бэкенд-разработчики.
- App (`app/`): провайдеры, сервисы, кастомные зависимости приложения.
- Конфигурации (`config/`, `nginx/`, `traefik/`, `docker-compose.yml`): DevOps / инженер по инфраструктуре.
- Зависимости / сборка (`composer.json`, `package.json`, `webpack.mix.js`): разработчики, отвечающие за сборочный пайплайн.

---

## Ведение журнала изменений (Changelog)

Для отслеживания истории изменений в проекте используется файл `edits-list.md`.

### Зачем это нужно?

1.  **Прозрачность**: Любой член команды может быстро понять, какие изменения, когда и с какой целью были внесены.
2.  **Отладка**: При возникновении ошибок журнал помогает определить, какие недавние правки могли стать причиной проблемы.
3.  **История проекта**: Служит централизованным архивом всех ключевых доработок и исправлений.

После выполнения значимой задачи (например, рефакторинг, добавление новой функции, исправление бага) необходимо добавлять в `edits-list.md` краткую запись с датой, номером правки (если применимо) и описанием выполненных работ.

---

## Стандартная функция для обработки путей медиафайлов (`resolveMediaPath`)

В PHP-секции (`<?php ... ?>`) шаблонов страниц, где требуется обрабатывать пути к изображениям из медиатеки (Tailor), необходимо использовать следующую полную версию функции `resolveMediaPath`.

Эта функция корректно обрабатывает различные форматы путей, которые могут приходить из CMS (строка, массив, объект), очищает их от служебных префиксов (`storage/app/media/` и т.д.) и генерирует правильный публичный URL через `MediaLibrary::url()`.

**Использование этой версии функции обязательно для обеспечения консистентности и избежания проблем с некорректными ссылками на медиафайлы.**

### Эталонный код функции

```php
$resolveMediaPath = static function ($value) {
    $path = null;

    if (is_object($value) && isset($value->path)) {
        $path = $value->path;
    } elseif (is_array($value)) {
        if (isset($value['path'])) {
            $path = $value['path'];
        } elseif (!empty($value)) {
            $first = reset($value);
            if (is_string($first)) {
                $path = $first;
            }
        }
    } elseif (is_string($value)) {
        $path = $value;
    }

    if (!is_string($path) || trim($path) === '') return null;

    $path = trim($path);
    if (preg_match('#^(https?:)?//#i', $path)) return $path;
    if (str_starts_with($path, '/themes/') || str_starts_with($path, '/storage/')) return $path;

    $normalizedPath = ltrim(str_replace('\\', '/', $path), '/');
    $stripPrefixes = ['storage/app/media/', 'storage/app/uploads/public/', 'storage/app/uploads/', 'storage/app/', 'storage/', 'app/media/', 'app/uploads/public/', 'media/'];
    foreach ($stripPrefixes as $prefix) {
        if (str_starts_with($normalizedPath, $prefix)) {
            $normalizedPath = ltrim(substr($normalizedPath, strlen($prefix)), '/');
            break;
        }
    }

    return ($normalizedPath === '') ? null : MediaLibrary::url($normalizedPath);
};
```

Если нужно — могу расширить этот файл диаграммой потоков (sequence/architecture), добавить конкретные команды для CI/CD, или составить чек-лист обновления October CMS и плагинов.
