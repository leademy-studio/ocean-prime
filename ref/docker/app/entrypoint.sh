#!/bin/sh
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Composer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd /var/www/html/

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞–ø–∫–∞ vendor
if [ ! -d "vendor" ] || [ ! -f "vendor/autoload.php" ]; then
    echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é Composer..."
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader
else
    echo "–ü–∞–ø–∫–∞ 'vendor' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–ø—É—Å–∫–∞—é 'composer install'."
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è October CMS
echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–ø–∫–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
mkdir -p storage/app storage/framework/cache storage/framework/sessions storage/framework/views storage/logs

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ www-data —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö –ø–∞–ø–æ–∫, –∫—É–¥–∞ –Ω—É–∂–Ω–∞ –∑–∞–ø–∏—Å—å
chown -R www-data:www-data bootstrap/cache storage themes plugins
chmod -R 775 bootstrap/cache storage themes plugins

# –§—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
wait_for_db() {
    echo "üîÑ –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    
    while ! php -r "
        try {
            new PDO('mysql:host=${DB_HOST:-db};port=${DB_PORT:-3306}', '${DB_USERNAME}', '${DB_PASSWORD}');
            echo '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ';
            exit(0);
        } catch (PDOException \$e) {
            exit(1);
        }
    " > /dev/null 2>&1; do
        echo "‚è≥ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞, –∂–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã..."
        sleep 3
    done
    
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞!"
}

# –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î
wait_for_db

echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–æ—Ç–æ–≤. –ó–∞–ø—É—Å–∫–∞–µ–º php-fpm..."

# –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ, php-fpm)
exec php-fpm
