# Инструкция по развертыванию проекта на October CMS на shared-хостинге

Этот документ описывает процесс переноса и настройки веб-приложения, разработанного на October CMS, из Docker-окружения на стандартный shared-хостинг (виртуальный хостинг). Инструкция предполагает, что у вас нет root-доступа к серверу и возможности использовать Docker.

---

### 1. Требования к хостингу

Перед началом убедитесь, что ваш тарифный план хостинга соответствует следующим требованиям:

*   **Веб-сервер:** Apache с включенным модулем `mod_rewrite` или Nginx.
*   **Версия PHP:** **8.2 или выше** (целевая версия 8.4). Убедитесь, что нужную версию можно выбрать в панели управления хостингом.
*   **Расширения PHP:** В настройках PHP должны быть включены следующие расширения:
    *   `pdo_mysql`
    *   `zip`
    *   `gd` (с поддержкой freetype, jpeg, webp, avif)
    *   `intl`
    *   `opcache`
    *   `bcmath`
    *   `exif`
    *   `mbstring`
    *   `xml`
*   **База данных:** MySQL версии 8.0+ или совместимая версия MariaDB.
*   **Доступ к серверу:**
    *   FTP, SFTP или файловый менеджер в панели управления.
    *   **Настоятельно рекомендуется** наличие SSH-доступа (даже ограниченного) для выполнения команд Composer и Artisan. Без него обслуживание сайта будет значительно затруднено.
*   **Настройки PHP:** Возможность редактировать `php.ini` или через файл `.user.ini`. Рекомендуемое значение `memory_limit` — не менее `512M`.

---

### 2. Подготовка файлов проекта

Все шаги в этом разделе выполняются на вашем локальном компьютере, где у вас есть полная копия проекта.

1.  **Установка зависимостей:**
    Откройте терминал в корневой папке проекта (`ocean-prime-website`) и выполните команду для установки производственных зависимостей. Это соберет все необходимые пакеты в папку `october/vendor`.
    ```bash
    composer install --no-dev --optimize-autoloader -d ./october
    ```

2.  **Создание архива:**
    Создайте ZIP-архив из содержимого папки `october`. В архив должны войти все файлы, включая папку `vendor`. Исключите папку `.git`, если она там есть.

---

### 3. Настройка на хостинге

1.  **Создание базы данных:**
    *   В панели управления хостингом (cPanel, Plesk и т.д.) перейдите в раздел управления базами данных.
    *   Создайте новую базу данных (например, `op_db`).
    *   Создайте нового пользователя для этой базы данных (например, `op_user`) и задайте ему надежный пароль.
    *   Предоставьте пользователю все права на созданную базу данных.
    *   Сохраните имя базы, имя пользователя и пароль — они понадобятся на следующем шаге.

2.  **Загрузка файлов:**
    *   Через файловый менеджер или FTP-клиент загрузите созданный на шаге 2 ZIP-архив в корневую директорию вашего сайта (обычно это `public_html` или `httpdocs`).
    *   Распакуйте архив в этой директории. В результате у вас должна получиться структура вида `public_html/config`, `public_html/vendor` и т.д.

3.  **Настройка окружения (`.env`):**
    *   В корневой директории сайта найдите файл `.env.example` (внутри папки `october`) и скопируйте его в корень сайта под именем `.env`.
    *   Откройте файл `.env` для редактирования и укажите следующие параметры:

        ```ini
        # Установите в 'production' для боевого режима
        APP_ENV=production
        APP_DEBUG=false

        # Укажите ваш домен
        APP_URL=https://www.ocean

        # Данные для подключения к базе данных (из шага 3.1)
        DB_CONNECTION=mysql
        DB_HOST=localhost # Или адрес сервера БД, указанный хостером
        DB_PORT=3306
        DB_DATABASE=имя_вашей_базы_данных
        DB_USERNAME=имя_пользователя_бд
        DB_PASSWORD=пароль_пользователя_бд
        ```

---

### 4. Настройка веб-сервера

Поскольку `index.php` находится в корне проекта, а не в подпапке `public`, требуется специальная настройка веб-сервера.

#### Для Apache

Создайте или отредактируйте файл `.htaccess` в корневой директории сайта (`public_html`) и добавьте в него следующий код. Он будет перенаправлять все запросы на главный файл `index.php`.

```apache
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Редирект с www на основной домен
    RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

    # Редирект с HTTP на HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Перенаправлять все запросы, которые не являются файлами или папками, на index.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [L]

    # Блокировка доступа к чувствительным файлам и папкам
    <Files .env>
        Order allow,deny
        Deny from all
    </Files>
    RedirectMatch 403 ^/(config|vendor|storage/cms/twig|storage/logs|themes/.*/(bin|node_modules|tests|src)|themes/.*/(config|meta|version\.yaml))
</IfModule>
```

#### Для Nginx

На shared-хостинге с Nginx у вас, скорее всего, нет прямого доступа к файлам конфигурации.
1.  Поищите в панели управления хостингом раздел "Настройки Nginx" или подобный.
2.  Если такой раздел есть, вам нужно убедиться, что для вашего сайта используется правило, аналогичное этому:
    ```nginx
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    ```
3.  Если такой опции нет, обратитесь в службу поддержки вашего хостинга с просьбой настроить обработку всех запросов через `index.php` для вашего сайта.

---

### 5. Конфигурация October CMS

После настройки окружения необходимо убедиться, что CMS разрешает загрузку современных форматов изображений.

1.  **Разрешение форматов .avif и .webp:**
    Чтобы иметь возможность загружать изображения в форматах `avif` или `webp` через медиа-менеджер, их нужно добавить в конфигурационный файл системы.
    *   Откройте файл `october/config/system.php` через файловый менеджер.
    *   Найдите массив `allowed_file_types`.
    *   Убедитесь, что в нем присутствуют строки `'avif'` и `'webp'`. Если их нет, добавьте их.

    Пример:
    ```php
    'allowed_file_types' => [
        // ... другие форматы
        'webp',
        'avif',
    ],
    ```
---

### 6. Завершение установки (через SSH)

Этот шаг **критически важен** для создания таблиц в базе данных и очистки кэша.

1.  Подключитесь к вашему хостингу по SSH.
2.  Перейдите в корневую директорию сайта:
    ```bash
    cd public_html
    ```
3.  Выполните миграцию базы данных. Команда создаст все необходимые таблицы для работы CMS и плагинов.
    ```bash
    php artisan october:migrate --force
    ```
4.  Очистите кэш конфигурации и маршрутов, чтобы применились все настройки из `.env` файла:
    ```bash
    php artisan cache:clear
    php artisan config:clear
    php artisan route:clear
    php artisan view:clear
    ```
5.  Если после развертывания возникают проблемы с кастомными плагинами (например, `Leademy.Leads`), выполните команду для их "переустановки":
    ```bash
    php artisan plugin:refresh Leademy.Leads
    ```

> **Что делать, если нет SSH?**
> Обслуживание проектов на October CMS без SSH-доступа крайне затруднительно. Вам придется импортировать дамп базы данных вручную через phpMyAdmin и искать способы очистки кэша (например, через временные PHP-скрипты, что небезопасно). **Настоятельно рекомендуется сменить тариф или хостинг-провайдера на тот, что предоставляет SSH-доступ.**

---

### 7. Настройка прав доступа

Неправильные права на файлы — частая причина ошибок 500 или 403. Веб-сервер должен иметь права на запись в определенные директории.

1.  С помощью вашего FTP-клиента или файлового менеджера установите следующие права:
    *   На папки `storage`, `bootstrap/cache` — права `775`.
    *   На все остальные папки — права `755`.
    *   На все файлы — права `644`.

2.  Если после установки прав сайт все еще выдает ошибку, связанную с доступом, попробуйте установить права `777` на папки `storage` и `bootstrap/cache` временно для диагностики. Однако оставлять такие права на постоянной основе небезопасно.

---

### 8. Финальная проверка

1.  Откройте ваш сайт в браузере и убедитесь, что главная страница загружается без ошибок.
2.  Перейдите по адресу `/backend` для доступа к административной панели.
3.  Проверьте работу форм обратной связи, загрузки файлов и других динамических элементов сайта.
4.  Убедитесь, что все изображения и стили отображаются корректно.
