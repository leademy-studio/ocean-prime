#!/bin/bash

# ==================================================================================
# –£—Å—Ç–∞–Ω–æ–≤–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ Leademy
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
# 1. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º—É –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã (git, curl).
# 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Docker –∏ Docker Compose.
# 3. –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–æ–µ–∫—Ç–∞.
# 4. –°–æ–∑–¥–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (.env, acme.json).
# 5. –°–æ–±–∏—Ä–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã.
# 6. –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π,
#    –º–∏–≥—Ä–∞—Ü–∏–∏, —Å–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞).
#
# –ü–ï–†–ï–î –ó–ê–ü–£–°–ö–û–ú:
# 1. –ó–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π GIT_REPO_URL –Ω–∞ URL –≤–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
# 2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ sudo –∏–ª–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è root.
# ==================================================================================

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---

GIT_REPO_URL="https://github.com/leademy-studio/ocean-prime.git" # –£–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π URL

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
PROJECT_DIR="/var/www/ocean-prime"

# --- –ö–û–î –°–ö–†–ò–ü–¢–ê ---

# –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –ª—é–±–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π
set -e

echo "üöÄ  –ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ Leademy..."

# --- 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---
echo "‚öôÔ∏è  [1/8] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
apt-get update
apt-get upgrade -y
apt-get install -y git curl

# --- 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–µ–ø–ª–æ—è ---
echo "‚öôÔ∏è  [2/8] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'deployer' –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–¥–æ—Å—Ç—É–ø–∞..."

# –í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
DEPLOY_PUBLIC_KEY="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIO5j3U8F/5OL0mYc76M/NUfE7nTecLJYlhoI0tb1Mivn ravilsakirov@MacBook-Pro.local"

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if id "deployer" &>/dev/null; then
    echo "‚ÑπÔ∏è  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'deployer' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
else
    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ø–∞—Ä–æ–ª—è, —Ç–∞–∫ –∫–∞–∫ –≤—Ö–æ–¥ –±—É–¥–µ—Ç –ø–æ –∫–ª—é—á—É
    adduser --disabled-password --gecos "" deployer
    echo "‚úÖ  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'deployer' —Å–æ–∑–¥–∞–Ω."
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é .ssh –∏ —Ñ–∞–π–ª authorized_keys
mkdir -p /home/deployer/.ssh
touch /home/deployer/.ssh/authorized_keys

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤ authorized_keys, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –µ—â–µ –Ω–µ—Ç
if grep -qF "$DEPLOY_PUBLIC_KEY" /home/deployer/.ssh/authorized_keys; then
    echo "‚ÑπÔ∏è  SSH –∫–ª—é—á —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'deployer'."
else
    echo "$DEPLOY_PUBLIC_KEY" >> /home/deployer/.ssh/authorized_keys
    echo "‚úÖ  –ü—É–±–ª–∏—á–Ω—ã–π SSH –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'deployer'."
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
chmod 700 /home/deployer/.ssh
chmod 600 /home/deployer/.ssh/authorized_keys
chown -R deployer:deployer /home/deployer/.ssh

# --- 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ Docker Compose ---
echo "‚öôÔ∏è  [2/8] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker..."
if ! command -v docker &> /dev/null
then
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deployer –≤ –≥—Ä—É–ø–ø—É docker, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
    usermod -aG docker deployer
    echo "‚úÖ  Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã, –ø–µ—Ä–µ–∑–∞–π–¥—è –≤ —Å–µ—Å—Å–∏—é, –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—É—é."
else
    echo "‚ÑπÔ∏è  Docker —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
fi

echo "‚öôÔ∏è  [3/8] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose..."
if ! command -v docker-compose &> /dev/null
then
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ Docker Compose
    LATEST_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    curl -L "https://github.com/docker/compose/releases/download/${LATEST_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
    echo "‚úÖ  Docker Compose ${LATEST_COMPOSE_VERSION} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
else
    echo "‚ÑπÔ∏è  Docker Compose —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
fi

# --- 3. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ---
echo "‚öôÔ∏è  [4/8] –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞..."
if [ -d "$PROJECT_DIR" ]; then
    echo "‚ÑπÔ∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ $PROJECT_DIR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ."
else
    git clone "$GIT_REPO_URL" "$PROJECT_DIR"
    echo "‚úÖ  –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω –≤ $PROJECT_DIR."
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ —ã
cd "$PROJECT_DIR"

# --- 4. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ---
echo "‚öôÔ∏è  [5/8] –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."

if [ -f ".env" ]; then
    echo "‚ÑπÔ∏è  –§–∞–π–ª .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
else
    if [ -f ".env.example" ]; then
        cp .env.example .env
        echo "‚úÖ  –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ!"
    else
        echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –§–∞–π–ª .env.example –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å .env –≤—Ä—É—á–Ω—É—é."
    fi
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ Traefik
if [ -f "traefik/acme.json" ]; then
    echo "‚ÑπÔ∏è  –§–∞–π–ª traefik/acme.json —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
else
    mkdir -p traefik
    touch traefik/acme.json
    chmod 600 traefik/acme.json
    echo "‚úÖ  –§–∞–π–ª traefik/acme.json —Å–æ–∑–¥–∞–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ 600."
fi

# --- 5. –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ---
echo "‚úÖ  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã –∏ –∑–∞–ø—É—â–µ–Ω—ã."
# --- 6. –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ---
echo "‚öôÔ∏è  [6/8] –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
echo "‚è≥  –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è..."
docker compose up -d --build

echo "‚úÖ  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã –∏ –∑–∞–ø—É—â–µ–Ω—ã."
sleep 15

# --- 7. –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
echo "‚öôÔ∏è  [7/8] –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

echo "--- 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Composer ---"
docker compose exec -T app composer install --no-interaction --prefer-dist --optimize-autoloader

echo "--- 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π October CMS ---"
docker compose exec -T app php artisan october:up

echo "--- 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ storage –∏ cache ---"
docker compose exec -T app chmod -R 775 storage bootstrap/cache
docker compose exec -T app chown -R www-data:www-data storage bootstrap/cache

echo "‚úÖ  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

# --- 8. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ---
echo "üéâ  [8/8] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo
echo "--- –í–∞–∂–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ ---"
echo "1.  –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª '.env' –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—á—Ç—ã –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è."
echo
echo "2.  –ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è '.env' –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–æ–º–∞–Ω–¥–æ–π:"
echo "    cd ${PROJECT_DIR} && docker compose up -d --build"
echo
echo "3.  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DNS A-–∑–∞–ø–∏—Å—å –¥–ª—è –¥–æ–º–µ–Ω–∞ 'ocean-prime.com' (–∏ 'www.ocean-prime.com') —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ IP-–∞–¥—Ä–µ—Å —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞. Traefik –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç."
echo
echo "4.  –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É Traefik –æ—Ç–∫—Ä–æ–π—Ç–µ http://<IP-–∞–¥—Ä–µ—Å-—Å–µ—Ä–≤–µ—Ä–∞>:8080"
echo "-----------------------------------"

exit 0
